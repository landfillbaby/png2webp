#!/usr/bin/env sh
webpflags=
nothreads=0
fopenx=2
[ -z "$CC" ] && CC=cc
while [ $# -gt 0 ]; do
	case "$1" in
		--disable-threading) nothreads=1;;
		--enable-fopen-x) fopenx=1;;
		--disable-fopen-x) fopenx=0;;
		--help)
			echo 'usage: ./configure [flags]'
			echo flags:
			echo --disable-threading: force single-threaded build
			echo default is to follow libwebp\'s threading test
			echo
			echo '--enable-fopen-x: force use of C11 fopen("wbx")'
			echo '--disable-fopen-x: force use of POSIX fdopen()'
			echo default is to compile and run test/fopenx.c
			exit 1;;
		*) echo "unknown option '$1'"; exit 1;;
	esac
	shift
done
if [ $nothreads -eq 1 ]; then
	webpflags=--disable-threading
fi
origCPPFLAGS="$CPPFLAGS"
CPPFLAGS="-I$PWD/zlib -I$PWD/libpng -I$PWD/libwebp -I$PWD/libwebp/src $CPPFLAGS"
if [ -x zlib/configure ]; then
	echo configuring zlib...
	cd zlib
	./configure
	echo configured zlib
	cd ..
else
	echo ERROR: can\'t exec zlib/configure
	exit 1
fi
if [ -x libpng/configure ]; then
	echo configuring libpng...
	cd libpng
	cp scripts/pnglibconf.h.prebuilt pnglibconf.h
	./configure --enable-hardware-optimizations ac_cv_lib_z_zlibVersion=yes
	echo configured libpng
	cd ..
else
	echo ERROR: can\'t exec libpng/configure
	exit 1
fi
if [ -x libwebp/autogen.sh ]; then
	echo configuring libwebp...
	cd libwebp
	./autogen.sh
	./configure --disable-near-lossless $webpflags
	echo configured libwebp
	cd ..
else
	echo ERROR: can\'t exec libwebp/autogen.sh
	exit 1
fi
CPPFLAGS="$origCPPFLAGS"
if [ $nothreads -eq 0 ] &&
	! grep -Fxq '#define WEBP_USE_THREAD 1' libwebp/src/webp/config.h
then
	echo threading disabled by libwebp
	nothreads=2
fi
if [ $fopenx -eq 2 ]; then
	echo 'testing C11 fopen("wbx") support'
	cd test
	if $CC $CFLAGS $CPPFLAGS $LDFLAGS fopenx.c $LDLIBS -o fopenx && ./fopenx
	then
		echo test succeeded
		fopenx=1
	else
		echo test failed
		fopenx=0
	fi
	rm -f fopenx
	cd ..
fi
echo '// p2wconf.h; see README.md' > p2wconf.h
if [ $nothreads -ge 1 ]; then
	[ $nothreads -eq 1 ] && echo threading disabled by user
	echo '#define NOTHREADS 1' >> p2wconf.h
	echo 'PTHREAD_CC =' > pthreadvars.make
	echo 'PTHREAD_CFLAGS =' >> pthreadvars.make
	echo 'PTHREAD_LIBS =' >> pthreadvars.make
else
	echo threading enabled
	echo '// #undef NOTHREADS' >> p2wconf.h
	grep -E '^PTHREAD_(CC|CFLAGS|LIBS)[^[:alnum:]_]' \
		libwebp/Makefile > pthreadvars.make
fi
if [ $fopenx -eq 1 ]; then
	echo 'using C11 fopen("wbx")'
	echo '// #undef NOFOPENX' >> p2wconf.h
else
	echo 'using POSIX fdopen() instead of  C11 fopen("wbx")'
	echo '#define NOFOPENX 1' >> p2wconf.h
fi
